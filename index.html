<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>即時天氣查詢 - 會稽區</title>
<style>
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  margin: 0;
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  transition: background 1s ease;
  color: #fff;
  background: linear-gradient(to bottom,#0f2027,#203a43,#2c5364);
}
#weather-card {
  background: rgba(0,0,0,0.6);
  padding: 25px 20px;
  border-radius: 20px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.7);
  max-width: 500px;
  width: 95%;
  text-align: center;
}
h1 { 
  font-size:22px; 
  margin-bottom:15px; 
  color:#00f0ff; 
  text-shadow:2px 2px 8px rgba(0,0,0,0.6);
}
#weather { 
  font-size:16px; 
  line-height:1.6; 
  margin-bottom:10px;
  transition: opacity 0.5s ease;
}
#timeText {
  font-family: monospace;
  font-size:16px;
  margin-top:15px;
  color:#ffea00;
  text-align: center;
}
select, button {
  padding:5px 10px;
  border-radius:5px;
  border:none;
  margin-bottom:10px;
  width:80%;
  font-size:16px;
  cursor:pointer;
}
button {
  background-color:#00aaff;
  color:#fff;
}
button:hover {
  background-color:#0088cc;
}
#hourly-weather {
  display: flex;
  overflow-x: auto;
  gap: 10px;
  margin-top:15px;
  background: rgba(255,255,255,0.1);
  border-radius: 10px;
  padding:10px;
}
.hour-cell {
  flex: 0 0 60px;
  display:flex;
  flex-direction: column;
  align-items: center;
  font-size:14px;
}
.hour-cell .icon {
  font-size:24px;
  margin:5px 0;
}
#daily-temp {
  margin-top:10px;
  font-size:16px;
}
</style>
</head>
<body>
<div id="weather-card">
  <h1>桃園市桃園區會稽地區</h1>
  <select id="citySelect" onchange="changeCity()">
    <option value="朝陽里">朝陽里</option>
    <option value="青溪里">青溪里</option>
    <option value="成功里">成功里</option>
    <option value="三民里">三民里</option>
    <option value="忠義里">忠義里</option>
    <option value="福元里">福元里</option>
    <option value="三元里">三元里</option>
    <option value="大興里">大興里</option>
    <option value="會稽里">會稽里</option>
    <option value="檜樂里">檜樂里</option>
    <option value="大業里">大業里</option>
    <option value="大有里">大有里</option>
    <option value="寶山里">寶山里</option>
    <option value="寶民里">寶民里</option>
    <option value="春日里">春日里</option>
    <option value="汴洲里">汴洲里</option>
    <option value="東門里">東門里</option>
    <option value="東山里">東山里</option>
    <option value="萬壽里">萬壽里</option>
  </select>
  <br>
  <button onclick="randomCity()">隨機選一個里</button>

  <div id="weather">讀取中...</div>
  <div id="hourly-weather"></div>
  <div id="daily-temp"></div>
  <div id="timeText">時間載入中...</div>
</div>

<script>
let currentCity="朝陽里";
const cityCoords={
  "朝陽里":{lat:24.9970,lon:121.3020},
  "青溪里":{lat:24.9980,lon:121.3040},
  "成功里":{lat:24.9990,lon:121.3060},
  "三民里":{lat:25.0000,lon:121.3080},
  "忠義里":{lat:25.0010,lon:121.3100},
  "福元里":{lat:25.0020,lon:121.3120},
  "三元里":{lat:25.0030,lon:121.3140},
  "大興里":{lat:25.0040,lon:121.3160},
  "會稽里":{lat:25.0050,lon:121.3180},
  "檜樂里":{lat:25.0060,lon:121.3200},
  "大業里":{lat:25.0070,lon:121.3220},
  "大有里":{lat:25.0080,lon:121.3240},
  "寶山里":{lat:25.0090,lon:121.3260},
  "寶民里":{lat:25.0100,lon:121.3280},
  "春日里":{lat:25.0110,lon:121.3300},
  "汴洲里":{lat:25.0120,lon:121.3320},
  "東門里":{lat:25.0130,lon:121.3340},
  "東山里":{lat:25.0140,lon:121.3360},
  "萬壽里":{lat:25.0150,lon:121.3380}
};

function getUrl(city){
  const coords = cityCoords[city] || cityCoords["朝陽里"];
  return `https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lon}&current_weather=true&hourly=temperature_2m,apparent_temperature,precipitation,precipitation_probability,relative_humidity_2m,uv_index&timezone=Asia/Taipei`;
}

function uvLevel(index){
  if(index<3) return "低";
  if(index<6) return "中";
  if(index<8) return "高";
  if(index<11) return "很高";
  return "危險";
}

function updateTimeText() {
  const now = new Date();
  const y = now.getFullYear();
  const m = (now.getMonth()+1).toString().padStart(2,'0');
  const d = now.getDate().toString().padStart(2,'0');
  const h = now.getHours().toString().padStart(2,'0');
  const min = now.getMinutes().toString().padStart(2,'0');
  const s = now.getSeconds().toString().padStart(2,'0');
  document.getElementById("timeText").innerText=`當前時間：${y}-${m}-${d} ${h}:${min}:${s}`;
}

function getBackgroundColor(cw, precipitation, todayMax){
  const hour = new Date().getHours();
  const isNight = hour<6 || hour>=18;
  if(precipitation > 0) return "linear-gradient(to bottom,#4a90e2,#50a7f9)";
  if(isNight) return "linear-gradient(to bottom,#0d1b2a,#1b263b)";
  if(todayMax >= 30) return "linear-gradient(to bottom,#ff7e5f,#feb47b)";
  if(todayMax >= 25) return "linear-gradient(to bottom,#fbc2eb,#a6c1ee)";
  return "linear-gradient(to bottom,#0f2027,#203a43,#2c5364)";
}

function fetchWeather(){
  const weatherDiv = document.getElementById("weather");
  const hourlyDiv = document.getElementById("hourly-weather");
  const dailyDiv = document.getElementById("daily-temp");
  weatherDiv.style.opacity = 0;
  hourlyDiv.innerHTML = "讀取中...";
  dailyDiv.innerHTML = "";

  fetch(getUrl(currentCity))
    .then(res => { if(!res.ok) throw new Error("無法取得天氣資料"); return res.json(); })
    .then(data => {
      const cw = data.current_weather;
      const h = data.hourly;
      const now = new Date();
      let closestIndex = 0, minDiff = Infinity;

      h.time.forEach((t,i)=>{
        const diff=Math.abs(new Date(t).getTime()-now.getTime());
        if(diff<minDiff){ minDiff=diff; closestIndex=i; }
      });

      const todayDate = now.toISOString().slice(0,10);
      const todayTemps = h.temperature_2m.filter((_,i)=> h.time[i].startsWith(todayDate));
      const todayMax = Math.max(...todayTemps);
      const todayMin = Math.min(...todayTemps);

      const precipitation = h.precipitation[closestIndex];
      const precipitationProb = h.precipitation_probability ? h.precipitation_probability[closestIndex] : 'N/A';
      const humidity = h.relative_humidity_2m[closestIndex];
      const apparentTemp = h.apparent_temperature[closestIndex];
      const uvIndex = h.uv_index[closestIndex];
      const uvText = uvLevel(uvIndex);

      let rainNotice = "";
      if(precipitation > 0) rainNotice = "<br>🌂 注意：今天會下雨，記得帶傘！";

      weatherDiv.innerHTML=`
        🌡️ 溫度：${cw.temperature}°C <br>
        🥵 體感溫度：${apparentTemp}°C <br>
        💨 風速：${cw.windspeed} m/s <br>
        🌬️ 風向：${cw.winddirection}° <br>
        🌧️ 降雨量：${precipitation} mm <br>
        ☔ 降雨機率：${precipitationProb}% <br>
        💧 濕度：${humidity}% <br>
        🌞 紫外線：${uvIndex} (${uvText})
        ${rainNotice}
      `;

      // 每小時天氣完整表格（今天 0~23 時）
      let htmlHourly = "";
      for(let i=0; i<h.time.length; i++){
        if(!h.time[i].startsWith(todayDate)) continue;
        const date = new Date(h.time[i]);
        const hour = date.getHours();
        const temp = h.temperature_2m[i];
        const precipHour = h.precipitation[i];

        let icon = "☁️";
        if(precipHour>0) icon="🌧️";
        else if(temp>30) icon="🌞";
        else if(temp<20) icon="❄️";

        htmlHourly += `
          <div class="hour-cell">
            <div>${hour}:00</div>
            <div class="icon">${icon}</div>
            <div>${temp}°C</div>
          </div>
        `;
      }
      hourlyDiv.innerHTML = htmlHourly;
      dailyDiv.innerHTML = `🔺 最高：${todayMax}°C &nbsp;&nbsp; 🔻 最低：${todayMin}°C`;

      document.body.style.background = getBackgroundColor(cw, precipitation, todayMax);
      setTimeout(()=>{ weatherDiv.style.opacity = 1; },50);
    })
    .catch(err=>{
      weatherDiv.innerHTML=`<span style="color:#ff6b6b">錯誤：${err.message}</span>`;
      hourlyDiv.innerHTML = "";
      dailyDiv.innerHTML = "";
      weatherDiv.style.opacity = 1;
    });
}

function changeCity(){
  currentCity = document.getElementById("citySelect").value;
  fetchWeather();
}

function randomCity(){
  const cities = Object.keys(cityCoords);
  const randomIndex = Math.floor(Math.random() * cities.length);
  currentCity = cities[randomIndex];
  document.getElementById("citySelect").value = currentCity;
  fetchWeather();
}

setInterval(updateTimeText,1000);
fetchWeather();
setInterval(fetchWeather,5000);
</script>
</body>
</html>
